INIT / SECURE - INSTRUKCE PRO NASAZENÍ KLÍČŮ A STORAGE
==================================================

Účel
----
Tento soubor popisuje, kam vložit tajné klíče, jak nastavit oprávnění a jak nakonfigurovat cestu k adresáři `storage/`.
Neukládejte tyto soubory do verzovacího systému (git). 

1) Umístění souborů (doporučené)
--------------------------------
Projektová struktura (příklad):
  /project-root/
    /secure/
      config.php
      /keys/
        key_v1.bin
        key_v2.bin
      init_env.README.txt    <-- tento soubor
    /storage/                <-- šifrované soubory, mimo webroot
      /books/
      /uploads/
    /www/
      /domains/
        /mojedomena/
          /eshop/            <-- webroot aplikace

- `secure/` musí být umístěno mimo webroot (`/www/...`).
- `storage/` musí být mimo webroot — výše je doporučené umístění `/project-root/storage`.

2) Klíče (master key)
---------------------
- Umísti master keys do: `/project-root/secure/keys/`
  - název souboru např. `key_v1.bin`, `key_v2.bin`
- Oprávnění:
  - soubory klíčů: `chmod 600 key_v1.bin` (vlastník: webserver user, např. www-data)
  - adresář keys: `chmod 700 keys`
  - soubor `secure/config.php`: `chmod 640` (čtení pouze pro webserver a případně deployer)
- Nikdy necommituj tyto klíče do Git nebo jiného VCS.

3) Storage (soubory / knihy)
----------------------------
- Ulož `storage/` mimo webroot. Měj ji na stejné úrovni jako `secure/` (např. `/project-root/storage`).
- Oprávnění:
  - adresář `storage` a podsložky: vlastník = webserver uživatel (www-data), `chmod 750` / `chmod 770` podle potřeby.
- Zamez přímému HTTP přístupu (je-li to nutné, doplň .htaccess, nginx rule apod.).

4) Jak nastavit `paths` v konfiguraci
-------------------------------------
- Ideální přístup: **NEHÁDEJ** počet `../`. Použij environmentální proměnnou `STORAGE_PATH` nebo malou funkci, která "najde nahoru" adresář `storage`.
- Pokud nemůžeš použít env, spočítej relativně od umístění `config.php`. (Viz oddíl níže s příklady.)

5) Doporučená bezpečnostní opatření
-----------------------------------
- V produkci vždy HTTPS + `session.cookie_secure = 1`.
- Nastav `session.cookie_httponly = 1` a `session.use_strict_mode = 1`.
- Ověř, že storage a keys nejsou dostupné přes webserver (403).
- Periodická rotace klíčů: vytvoř `key_v2.bin`, aktualizuj `secure/config.php` s novou `key_version`, proveď migraci šifrování dle interního postupu.
- Zálohuj klíče mimo server (offline icebox) — bez nich nejsou data dostupná.

6) Rychlé testy (po nasazení)
-----------------------------
- `php -r "echo is_dir('/absolute/path/to/project-root/storage') ? 'OK' : 'MISSING';"`
- V aplikaci vygeneruj testní upload (admin) a pokus se stáhnout soubor prostřednictvím dešifrovacího endpointu.
- Ujisti se, že `secure/config.php` nespadá do webrootu.

7) Kontakty / poznámky
----------------------
- Pokud máš multi-domény (více webrootů pod `/www/domains/...`), vždy nastav `storage` a `secure` na centrální místo mimo jednotlivé webrooty.
- Pokud chceš, vygeneruji ti přímo `secure/config.php` snippet s fallbacky.

Konec souboru.